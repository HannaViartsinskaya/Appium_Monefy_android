name: Run Appium Tests

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci
        
      - name: Check app
        run: ls -l ./apps/Monefy.apk

      - name: Start emulator and run tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: default
          arch: x86_64
          profile: pixel
          emulator-options: -no-window -no-audio -no-boot-anim
          disable-animations: true
          script: |
            echo "Ensuring emulator is available..."
            adb wait-for-device
            echo "Emulator is ready."

            echo "Starting Appium..."
            npx appium --base-path / --port 4723 &
            APPIUM_PID=$!

            echo "Waiting for Appium to be ready..."
            npx wait-on http://127.0.0.1:4723/wd/hub/status

            echo "Running WebdriverIO tests..."
            npx wdio run ./wdio.conf.ts

            echo "Stopping Appium..."
            kill $APPIUM_PID

      - name: Upload Allure Results
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results
